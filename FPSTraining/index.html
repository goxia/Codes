<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>FPS 定位练习模式</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
    
    <style>
        /* CSS 准星：比 3D 准星更精准，永远在屏幕正中心 */
        #crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            transform: translate(-50%, -50%);
            pointer-events: none; /* 让鼠标点击穿透准星 */
            z-index: 1000;
        }
        #crosshair::before, #crosshair::after {
            content: '';
            position: absolute;
            background: #00FF00; /* 亮绿色，适合定位 */
        }
        #crosshair::before { top: 9px; left: 0; width: 20px; height: 2px; } /* 横线 */
        #crosshair::after { top: 0; left: 9px; width: 2px; height: 20px; } /* 竖线 */

        #score-board {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            font-family: 'Arial', sans-serif;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
            z-index: 1000;
        }
    </style>
</head>
<body>

    <div id="score-board">击杀数: <span id="score">0</span></div>
    <div id="crosshair"></div>

    <script>
        // -----------------------
        // 1. 简单音效（不用外部文件）
        // -----------------------
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            
            if (type === 'shoot') {
                // 高频短促的射击声
                osc.type = 'square';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'hit') {
                // 低频打击声
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.2);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            }
        }

        let score = 0;

        // -----------------------
        // 2. 子弹组件
        // -----------------------
        AFRAME.registerComponent('bullet', {
            init: function() {
                this.speed = 50; // 子弹速度（米/秒）
                this.direction = new THREE.Vector3();
                this.hit = false; // 命中后不再重复检测

                // 获取世界坐标系下的方向（A-Frame 摄像机前方）
                this.el.object3D.getWorldDirection(this.direction);
                // A-Frame 中 getWorldDirection 指向 -Z，这里取反让子弹向屏幕前方飞
                this.direction.multiplyScalar(-1); 
                
                // 2 秒后自动销毁，防止内存泄漏
                setTimeout(() => {
                    if (this.el.parentNode) {
                        this.el.parentNode.removeChild(this.el);
                    }
                }, 2000);
            },
            tick: function(time, timeDelta) {
                if (this.hit) return;

                // 移动子弹
                const step = this.speed * (timeDelta / 1000);
                this.el.object3D.position.addScaledVector(this.direction, step);

                // 简单的碰撞检测（距离检测）
                const enemies = document.querySelectorAll('.enemy');
                const bulletPos = this.el.object3D.position;

                enemies.forEach(enemy => {
                    const enemyPos = enemy.object3D.position;
                    const dist = bulletPos.distanceTo(enemyPos);

                    if (dist < 1.5) { // 小于 1.5m 认为命中
                        this.hit = true;
                        handleHit(enemy);
                        if (this.el.parentNode) {
                            this.el.parentNode.removeChild(this.el);
                        }
                    }
                });
            }
        });

        // -----------------------
        // 3. 枪械控制组件：生成子弹
        // -----------------------
        AFRAME.registerComponent('gun-controller', {
            init: function() {
                // 缓存场景和相机
                this.sceneEl = this.el.sceneEl;
                this.cameraEl = this.sceneEl.querySelector('[camera]');

                // 如果场景还没完全加载，晚一点再取一次 camera
                if (!this.cameraEl) {
                    this.sceneEl.addEventListener('loaded', () => {
                        this.cameraEl = this.sceneEl.querySelector('[camera]');
                    });
                }

                // 使用 click 事件，兼容性较好
                window.addEventListener('click', () => {
                    this.fire();
                });
            },
            fire: function() {
                if (!this.cameraEl) {
                    console.warn('Camera not ready, cannot fire yet');
                    return;
                }

                playSound('shoot');

                // 简单的枪口后坐力动画
                const gun = document.querySelector('#gun-model');
                if (gun) {
                    gun.setAttribute('animation', 'property: position; from: 0.2 -0.3 -0.5; to: 0.2 -0.3 -0.4; dur: 50; dir: alternate; loop: 1');
                }

                // 创建子弹实体
                const bullet = document.createElement('a-sphere');
                bullet.setAttribute('radius', '0.1');
                bullet.setAttribute('color', '#FFFF00'); // 黄色子弹
                bullet.setAttribute('shader', 'flat');   // 不受光照影响
                bullet.setAttribute('bullet', '');       // 绑定 bullet 组件

                // 从相机位置发射
                const worldPos = new THREE.Vector3();
                const worldRot = new THREE.Quaternion();
                this.cameraEl.object3D.getWorldPosition(worldPos);
                this.cameraEl.object3D.getWorldQuaternion(worldRot);

                // 将子弹放在摄像机稍前位置，避免贴脸
                bullet.object3D.position.copy(worldPos);
                bullet.object3D.quaternion.copy(worldRot);

                this.sceneEl.appendChild(bullet);
            }
        });

        // -----------------------
        // 4. 敌人 AI：追踪玩家
        // -----------------------
        AFRAME.registerComponent('enemy-ai', {
            schema: { speed: { default: 2.5 } },
            init: function () {
                this.playerEl = document.querySelector('#player');
                if (!this.playerEl) {
                    console.warn('Player entity not found for enemy-ai');
                }
                this.tmpDir = new THREE.Vector3();
            },
            tick: function(time, timeDelta) {
                if (!this.playerEl) return;

                const enemyPos = this.el.object3D.position;
                const playerPos = this.playerEl.object3D.position;

                // 朝玩家移动
                this.tmpDir.subVectors(playerPos, enemyPos);
                this.tmpDir.y = 0; // 保持在地面

                // 距离大于 1.5m 时才移动
                if (this.tmpDir.length() > 1.5) {
                    this.tmpDir.normalize();
                    const step = this.data.speed * (timeDelta / 1000);
                    enemyPos.addScaledVector(this.tmpDir, step);
                }

                // 让敌人面向玩家
                this.el.object3D.lookAt(playerPos.x, enemyPos.y, playerPos.z);
            }
        });

        // -----------------------
        // 5. 命中与重生逻辑
        // -----------------------
        function handleHit(enemyEl) {
            playSound('hit');
            score++;
            document.querySelector('#score').innerText = score;

            // 视觉反馈：变白闪一下
            const originalColor = enemyEl.getAttribute('color');
            enemyEl.setAttribute('color', 'white');
            
            // 立刻重生到新位置
            setTimeout(() => {
                enemyEl.setAttribute('color', originalColor);
                respawnEnemy(enemyEl);
            }, 50);
        }

        function respawnEnemy(el) {
            // 随机生成 X 和 Z 坐标 (-20 到 20 之间)
            let x, z;
            let safe = false;

            // 保证不会生成在玩家脸上（与原点保持一定距离）
            while (!safe) {
                x = (Math.random() - 0.5) * 40;
                z = (Math.random() - 0.5) * 40;
                if (Math.abs(x) > 5 || Math.abs(z) > 5) {
                    safe = true;
                }
            }

            el.object3D.position.set(x, 1, z);
        }

    </script>

    <!-- -----------------------
         6. A-Frame 场景
    ------------------------ -->
    <a-scene background="color: #111" fog="type: exponential; color: #111; density: 0.03">
        
        <!-- 地面 -->
        <a-plane position="0 0 0" rotation="-90 0 0" width="100" height="100" color="#222"></a-plane>

        <!-- 玩家+相机 -->
        <a-entity id="player" movement-controls="speed: 0.2" position="0 1.6 0">
            <a-entity camera look-controls="pointerLockEnabled: true">
                <!-- 简单的枪模型 -->
                <a-box id="gun-model" position="0.2 -0.3 -0.5" scale="0.1 0.1 0.6" color="#555"></a-box>
            </a-entity>
            <!-- 枪控制逻辑 -->
            <a-entity gun-controller></a-entity>
        </a-entity>

        <!-- 敌人 1 -->
        <a-box class="enemy" enemy-ai="speed: 2.0" position="0 1 -10" color="#00AAFF">
            <a-box color="black" scale="0.6 0.2 0.1" position="0 0.2 0.5"></a-box>
        </a-box>

        <!-- 敌人 2 -->
        <a-box class="enemy" enemy-ai="speed: 4.0" position="-10 1 -15" color="#FF3333">
            <a-box color="black" scale="0.6 0.2 0.1" position="0 0.2 0.5"></a-box>
        </a-box>

        <!-- 敌人 3 -->
        <a-box class="enemy" enemy-ai="speed: 3.0" position="10 1 -12" color="#FFAA00">
            <a-box color="black" scale="0.6 0.2 0.1" position="0 0.2 0.5"></a-box>
        </a-box>

        <!-- 灯光 -->
        <a-light type="ambient" color="#BBB"></a-light>
        <a-light type="directional" position="-1 1 0" intensity="0.5"></a-light>

    </a-scene>
    
    <div style="position:fixed; bottom:10px; left:10px; color:#888; pointer-events:none">
        提示：点击画面锁定鼠标 | WASD 移动 | 左键点击射击 | 敌人会无限重生
    </div>

</body>
</html>
